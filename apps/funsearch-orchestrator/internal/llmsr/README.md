# Introduction

`llmsr` is a system for discovering symbolic equations that optimize a quantitative objective.

# Overview

The system uses an Island Model Genetic Algorithm (GA) to evolve populations of **Equation Skeletons**. The GA consists of two primary components: an **Island-Level Loop** that evolves individuals within isolated populations and an **Island Management** process that facilitates migration between them.

# Equation Skeleton

An **equation skeleton** is a symbolic equation template generated by a Large Language Model (LLM). It defines the mathematical structure of an equation (i.e., the relationship between variables and functions) while leaving numerical coefficients as undetermined parameters for subsequent optimization.

# Island Management

Periodically, the **Island Management** process culls the lower-performing half of all islands, ranked by their best individual's score. New islands are created to replace them, seeded with elite individuals from the surviving top-performing islands.

# Island-Level Loop

In each evolutionary step, one island is selected uniformly at random to perform a single `sample -> propose -> observe -> propagate` cycle. Within an island, skeletons with identical scores are grouped into clusters.

### 1. Sample (Parent Selection)

A parent is chosen via a two-step process. This is repeated to gather the required number of parents.

#### a. Cluster Selection (Score-based)

A cluster `i` is selected from the island with probability `Pᵢ` using Boltzmann selection:
$$P_i = \frac{\exp(s_i/T_c)}{\sum_j \exp(s_j/T_c)}$$
- $s_i$: A score that defines the cluster i. All skeletons within this cluster share this identical score.
- $T_c$: A temperature parameter that anneals according to the schedule $T_c = T_0\left(1 - \frac{u \pmod N}{N}\right)$, where:
    - $T_0$: The initial temperature.
    - $u$: The current number of equation programs (i.e., the population size) in the island.
    - $N$: A hyperparameter that defines the cycle length of the temperature annealing schedule. It is independent of the island replacement process.

#### b. Skeleton Selection (Length-based)

A skeleton $f_i$ is selected from the chosen cluster with a probability proportional to $\exp(-\hat{l}_i/T_p)$.
- $T_p$: A fixed temperature parameter (typically 1).
- $\hat{l}_i$: The normalized program length of the skeleton, calculated as:
  $$
  \hat{l}_i = \frac{l_i - \min l}{\max l - \min l + \epsilon}
  $$
    - $l_i$: The program length of skeleton $f_i$.
    - $\min l$, $\max l$: The minimum and maximum program lengths in the selected cluster.
    - $\epsilon$: A small constant (e.g., $10^{-6}$) to prevent division by zero.

### 2. Propose (Skeleton Generation)

An LLM generates new equation skeletons from the selected parents. This is handled via a gRPC call to a dedicated `llmsr-worker` server.

### 3. Observe (Parameter Optimization & Scoring)

The coefficients for a proposed skeleton are determined by a numerical optimizer (e.g., BFGS) that minimizes error against a target dataset. This minimized error is then converted into a score for the GA (e.g., score = -error), which is a maximization objective. This step is also executed remotely on the `llmsr-worker` server via gRPC.

### 4. Propagate

A newly evaluated skeleton is added to its source island only if its score is higher than the island's current best, or if the scores are tied and its skeleton is shorter. If this condition is met, the skeleton is added to the cluster corresponding to its score. If no cluster exists for that score, a new one is created.